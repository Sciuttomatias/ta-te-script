<!doctype html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

        <title>TA-TE-SCRIPT</title>
    </head>
    <body class="text-center">
        <h1 class="p-3 m-3 display-4">TA-TE-SCRIPT</h1>
        <main class="container">
            <!-- Fila #1 -->
            <section class="row">

                <div class="col-4 p-3">
                    <button type="button" class="btn btn-outline-dark w-25">?</button>
                </div>
                <div class="col-4 p-3 border-left border-right">
                    <button type="button" class="btn btn-outline-dark w-25">?</button>
                </div>
                <div class="col-4 p-3">
                    <button type="button" class="btn btn-outline-dark w-25">?</button>
                </div>

            </section>
            <!-- Fila #2 -->
            <section class="row border-top border-bottom">
                
                <div class="col-4 p-3">
                    <button type="button" class="btn btn-outline-dark w-25">?</button>
                </div>
                <div class="col-4 p-3 border-left border-right">
                    <button type="button" class="btn btn-outline-dark w-25">?</button>
                </div>
                <div class="col-4 p-3">
                    <button type="button" class="btn btn-outline-dark w-25">?</button>
                </div>

            </section>
            <!-- Fila #3 -->
            <section class="row">
                
                <div class="col-4 p-3">
                    <button type="button" class="btn btn-outline-dark w-25">?</button>
                </div>
                <div class="col-4 p-3 border-left border-right">
                    <button type="button" class="btn btn-outline-dark w-25">?</button>
                </div>
                <div class="col-4 p-3">
                    <button type="button" class="btn btn-outline-dark w-25">?</button>
                </div>

            </section>

        </main>

        <!--- botÃ³n para inicializar juego --->
        <button type="button" id="leer-datos" class="btn btn-success mt-5">Refrescar juego</button>
        <button type="button" id="inicializar" class="btn btn-danger mt-5" disabled>Incializar juego</button>

    </body>
    <script>
        const botones = document.querySelector("main"). querySelectorAll("button")
        const boton_inicializar = document.querySelector("#inicializar")
        const boton_leerdatos = document.querySelector("#leer-datos")
        let nombreJugador = ""

        let cantidadJugadas = 0
        let jugadas = []

        boton_leerdatos.onclick = () => {
            leerJugadas()
            if(jugadas.length > 0){ boton_inicializar.removeAttribute("disabled") }
            actualizarTablero()
        }
        
        boton_inicializar.onclick = () => {

            borrarJson()
            boton_inicializar.setAttribute("disabled", true)
        }

        const elijePC = () => {
            let randomPC 
            do {
                randomPC = parseInt(Math.random() * 9)
                console.log(randomPC)
            } while( botones[randomPC].getAttribute("disabled") == "true" )
/*
            botones[randomPC].setAttribute("disabled", true)
            botones[randomPC].innerHTML = "O"
            botones[randomPC].classList.add("btn-secondary")
            botones[randomPC].classList.remove("btn-outline-dark")
*/           
            let jugadaPC = {
                    "jugador" : "",
                    "casilla" : "",
                    "simbolo" : ""
            }
            jugadaPC.jugador = "Computadora"
            jugadaPC.casilla = randomPC
            jugadaPC.simbolo = "O"

            jugadas.push(jugadaPC)

            enviarJugadas(jugadaPC)
        }

        botones.forEach(boton => {
            boton.onclick = (evento) => {
                boton.setAttribute("disabled", true)
                boton.innerHTML = "X"
                boton.classList.add("btn-primary")
                boton.classList.remove("btn-outline-dark")

                //console.log(evento)

                //log de jugadas
                let jugada = {
                    "jugador" : "",
                    "casilla" : "",
                    "simbolo" : ""
                }
                jugada.jugador = nombreJugador
                jugada.casilla = Array.from(botones).indexOf(boton)
                jugada.simbolo = "X"

                jugadas.push(jugada)

                //console.log(jugadas)

                // verificar cuantos quedan libres
                cantidadJugadas += 1

                enviarJugadas(jugada)

                if( cantidadJugadas < 5 ){
                    //elijePC()
                }
                else{
                    console.log(jugadas)
                }
            }
        })

        // actualizar tablero

        const actualizarTablero = () => {
            let casillaPC = jugadas[0].casilla
            let nombrePC = jugadas[0].jugador
            console.log(nombrePC)
            if(nombrePC != nombreJugador){
                botones[casillaPC].setAttribute("disabled", true)
                botones[casillaPC].innerHTML = "O"
                botones[casillaPC].classList.add("btn-secondary")
                botones[casillaPC].classList.remove("btn-outline-dark")
            }

        }
        
        //******************************* comunicacion con json.io

        const enviarJugadas = async (jugada) => {

            const configs = {
					method : "POST",
					headers : {
						"Content-Type" : "application/json"
					},
					body : JSON.stringify(jugada)
				}

				await fetch("https://jsonbox.io/box_14888aa3086df9bb1382", configs)

        }

        const leerJugadas = async() => {

            try {
					const response = await fetch("https://jsonbox.io/box_14888aa3086df9bb1382")
					const datos = await response.json()

					jugadas = datos.map( item => {
                        let jugada = {
                            "id" : "",
                            "jugador" : "",
                            "casilla" : "",
                            "simbolo" : ""
                        }

                        jugada.id = item._id
                        jugada.jugador = item.jugador
                        jugada.casilla = item.casilla
                        jugada.simbolo = item.simbolo


						return jugada
                    
                    })

                    console.log(jugadas)
                    console.log(jugadas.length)
                    if(jugadas.length == 0) { boton_inicializar.setAttribute("disabled", true) }
                }
            catch(error){
                alert("Ahhhhh... no tengo productos!!!!")
            }

        }
        
        const borrarJson = async () => {
            jugadas.forEach(element => {
                eliminarJugada(element.id)
            });
        }
        
        const eliminarJugada = async (id) => {

            const configs = {
                    method : "DELETE",
                    headers : { },
                    body : ""
                }

            await fetch(`https://jsonbox.io/box_14888aa3086df9bb1382/${id}`, configs)

            console.log(`https://jsonbox.io/box_14888aa3086df9bb1382/${id}`)
        }

        window.onload = () => {
            nombreJugador = prompt("Ingrese su nombre:")
        }

    </script>
</html>